from faker import Faker
from typing import Dict, Any, List
import random
from .base_generator import BaseGenerator


class VulnerabilityGenerator(BaseGenerator):
    """
    Генератор уязвимых данных для режима 'Уязвимые данные'.
    """

    def __init__(self, locale: str = "ru_RU"):
        super().__init__(locale)
        self.fake = Faker(locale)
        self.sql_payloads = self._init_sql_payloads()
        self.xss_payloads = self._init_xss_payloads()
        self.path_traversal_payloads = self._init_path_traversal_payloads()

    def _init_sql_payloads(self) -> List[str]:
        """Инициализация SQL-инъекций"""
        return [
            "' OR '1'='1",
            "' UNION SELECT username, password FROM users--",
            "'; DROP TABLE users--",
            "' OR 1=1--",
            "admin'--",
            "' AND 1=CAST((SELECT version()) AS int)--",
            "' WAITFOR DELAY '00:00:10'--",
            "' OR EXISTS(SELECT * FROM information_schema.tables)--"
        ]

    def _init_xss_payloads(self) -> List[str]:
        """Инициализация XSS payload-ов"""
        return [
            "<script>alert('XSS')</script>",
            "<img src=x onerror=alert('XSS')>",
            "<svg onload=alert('XSS')>",
            "javascript:alert('XSS')",
            "<body onload=alert('XSS')>",
            "<iframe src=javascript:alert('XSS')>",
            "<a href=javascript:alert('XSS')>click</a>"
        ]

    def _init_path_traversal_payloads(self) -> List[str]:
        """Инициализация Path Traversal payload-ов"""
        return [
            "../../../etc/passwd",
            "..\\..\\..\\windows\\system32\\drivers\\etc\\hosts",
            "%2e%2e%2f%2e%2e%2f%2e%2e%2fetc%2fpasswd",
            "....//....//....//etc/passwd",
            "../../../etc/shadow",
            "../../../../windows/win.ini"
        ]

    def generate_row(self) -> Dict[str, Any]:
        """
        Генерирует данные с уязвимостями одного типа.
        """
        vulnerability_type = random.choice(['sql', 'xss', 'path_traversal'])
        
        base_data = {
            "id": self.fake.uuid4(),
            "vulnerability_type": vulnerability_type,
            "description": f"Тестовая уязвимость типа {vulnerability_type.upper()}",
            "timestamp": self.fake.iso8601(),
            "source_ip": self.fake.ipv4(),
            "target_url": self.fake.url() if vulnerability_type in ['sql', 'xss'] else f"file:///{self.fake.file_path()}",
            "user_agent": self.fake.user_agent()
        }

        # Добавляем payload в зависимости от типа уязвимости
        if vulnerability_type == 'sql':
            base_data["payload"] = random.choice(self.sql_payloads)
            base_data["parameter"] = random.choice(['id', 'username', 'search', 'category'])
        elif vulnerability_type == 'xss':
            base_data["payload"] = random.choice(self.xss_payloads)
            base_data["parameter"] = random.choice(['name', 'comment', 'message', 'content'])
        else:  # path_traversal
            base_data["payload"] = random.choice(self.path_traversal_payloads)
            base_data["parameter"] = random.choice(['file', 'path', 'document', 'attachment'])

        return base_data

    def generate_sql_injection(self) -> Dict[str, Any]:
        """Генерирует специфически SQL-инъекцию"""
        return {
            "id": self.fake.uuid4(),
            "vulnerability_type": "sql",
            "payload": random.choice(self.sql_payloads),
            "parameter": random.choice(['id', 'username', 'password', 'search']),
            "database_type": random.choice(['MySQL', 'PostgreSQL', 'SQL Server', 'Oracle']),
            "timestamp": self.fake.iso8601(),
            "source_ip": self.fake.ipv4()
        }

    def generate_xss_payload(self) -> Dict[str, Any]:
        """Генерирует специфически XSS payload"""
        return {
            "id": self.fake.uuid4(),
            "vulnerability_type": "xss",
            "payload": random.choice(self.xss_payloads),
            "context": random.choice(['HTML', 'Attribute', 'JavaScript', 'URL']),
            "browser": random.choice(['Chrome', 'Firefox', 'Safari', 'Edge']),
            "timestamp": self.fake.iso8601(),
            "source_ip": self.fake.ipv4()
        }

    def generate_path_traversal(self) -> Dict[str, Any]:
        """Генерирует специфически Path Traversal атаку"""
        return {
            "id": self.fake.uuid4(),
            "vulnerability_type": "path_traversal",
            "payload": random.choice(self.path_traversal_payloads),
            "target_file": random.choice(['/etc/passwd', '/etc/shadow', '/windows/win.ini', 'config.php']),
            "os_type": random.choice(['Linux', 'Windows', 'Unix']),
            "timestamp": self.fake.iso8601(),
            "source_ip": self.fake.ipv4()
        }

    def validate_data(self, data: Dict[str, Any]) -> bool:
        """
        Проверяет валидность данных уязвимости.
        """
        required_fields = ['id', 'vulnerability_type', 'payload', 'timestamp']
        
        # Проверяем наличие обязательных полей
        for field in required_fields:
            if field not in data or not data[field]:
                return False

        # Проверяем корректность типа уязвимости
        if data['vulnerability_type'] not in ['sql', 'xss', 'path_traversal']:
            return False

        # Проверяем, что payload соответствует типу уязвимости
        if data['vulnerability_type'] == 'sql' and data['payload'] not in self.sql_payloads:
            return False
        elif data['vulnerability_type'] == 'xss' and data['payload'] not in self.xss_payloads:
            return False
        elif data['vulnerability_type'] == 'path_traversal' and data['payload'] not in self.path_traversal_payloads:
            return False

        return True

    @property
    def generator_type(self) -> str:
        return "vulnerability"

    def get_supported_fields(self) -> List[str]:
        return [
            "id", "vulnerability_type", "payload", "parameter", "description",
            "timestamp", "source_ip", "target_url", "user_agent"
        ]

    def get_vulnerability_types(self) -> List[str]:
        """Возвращает список поддерживаемых типов уязвимостей"""
        return ['sql', 'xss', 'path_traversal']